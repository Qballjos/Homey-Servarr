<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Downloads</title><script src="/lib/homey.js"></script><style>body{margin:0;padding:15px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:0 0}.widget-container{text-align:center}.queue-info{margin-bottom:20px}.count{font-size:36px;font-weight:700;color:#2c3e50;margin:5px 0}.label{font-size:12px;color:#7f8c8d;text-transform:uppercase;letter-spacing:1px}.list{list-style:none;padding:0;margin:10px 0 0 0;text-align:left}.list li{display:flex;align-items:center;gap:8px;padding:6px 4px;border-bottom:1px solid #ecf0f1;font-size:13px;color:#2c3e50}.flag{width:10px;height:10px;border-radius:2px;display:inline-block}.title{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.status{font-size:12px;color:#7f8c8d;min-width:70px;text-align:right}.badges{display:flex;gap:6px;margin-left:18px;margin-top:2px;flex-wrap:wrap}.badge{background:#ecf0f1;color:#34495e;padding:2px 6px;border-radius:4px;font-size:11px;line-height:1.4}.badge-status{background:#95a5a6;color:white}.badge-eta{background:#3498db;color:white}.badge-size{background:#27ae60;color:white}.actions-row{display:flex;gap:6px}.btn-mini{padding:6px 10px;border:none;border-radius:4px;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;display:inline-block}.btn-remove{background:#e67e22;color:white}.btn-remove:hover{background:#d35400}.btn-block{background:#c0392b;color:white}.btn-block:hover{background:#922b21}.actions,.toolbar{display:flex;gap:10px;justify-content:center}.toolbar{margin-top:8px}.btn{flex:1;padding:12px 20px;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;text-transform:uppercase;letter-spacing:.5px}.btn-pause{background:#e74c3c;color:white}.btn-pause:hover{background:#c0392b}.btn-resume{background:#27ae60;color:white}.btn-resume:hover{background:#229954}.btn:active{transform:scale(.95)}.legend{margin-top:10px;font-size:11px;color:#7f8c8d;text-align:left;line-height:1.4}.errors{margin-top:10px;font-size:12px;color:#c0392b;text-align:left;line-height:1.4}.stats{margin-top:8px;font-size:12px;color:#7f8c8d;text-align:left}.filters{margin-top:8px;font-size:12px;color:#2c3e50;text-align:left}.filters label{display:inline-flex;align-items:center;gap:6px;cursor:pointer;user-select:none}</style></head><body><div class="widget-container"><div class="queue-info"><div class="label">Queue</div><div class="count" id="queue-count">0</div><div class="label" style="margin-top:5px;">Items</div></div><div class="actions"><button class="btn btn-pause" id="btn-pause">Pause</button><button class="btn btn-resume" id="btn-resume">Resume</button></div><div class="toolbar"><button class="btn btn-pause" id="btn-refresh" style="flex:0 0 auto;">Refresh</button><button class="btn btn-resume" id="btn-refresh-radarr" style="flex:0 0 auto;">Radarr</button><button class="btn btn-resume" id="btn-refresh-sonarr" style="flex:0 0 auto;">Sonarr</button><button class="btn btn-resume" id="btn-refresh-lidarr" style="flex:0 0 auto;">Lidarr</button></div><div class="filters"><label><input type="checkbox" id="toggle-active"> Show only active items</label></div><ul class="list" id="queue-list"></ul><div class="legend"><div><strong>Remove</strong>: remove from queue.</div><div><strong>Block</strong>: block and remove.</div></div><div class="stats" id="stats"></div><div class="errors" id="error-box"></div></div><script>Homey.ready();const device=Homey.getDevice(),listEl=document.getElementById("queue-list"),countEl=document.getElementById("queue-count"),errorBox=document.getElementById("error-box"),statsEl=document.getElementById("stats"),toggleActiveEl=document.getElementById("toggle-active"),appColors={sonarr:"#3498db",radarr:"#f1c40f",lidarr:"#27ae60"};function renderStats(e){statsEl.textContent=`R:${e.radarr||0}  S:${e.sonarr||0}  L:${e.lidarr||0}`}function formatSize(e){if(!e||isNaN(e))return null;const t=e/1073741824;return t>=.1?`${t.toFixed(1)} GB`:`${(e/1048576).toFixed(0)} MB`}function formatEta(e){if(!e)return null;const t=new Date(e);if(!isNaN(t)){const e=t.getTime()-Date.now();if(e<=0)return"00:00";const r=Math.floor(e/6e4);return`${Math.floor(r/60).toString().padStart(2,"0")}:${(r%60).toString().padStart(2,"0")}`}return"string"==typeof e?e:null}function normalizeStatus(e){if(!e)return"";const t=e.toString().toLowerCase();return t.includes("download")?"Downloading":t.includes("queue")?"Queued":t.includes("import")?"Importing":t.includes("pause")?"Paused":t.includes("block")?"Blocked":t.includes("complete")?"Completed":e}function renderList(e){if(listEl.innerHTML="",!e||0===e.length)return void(listEl.innerHTML="<li>No items in queue</li>");const t=toggleActiveEl.checked,r=t?e.filter(e=>{const t=(e.status||"").toLowerCase();return!(t.includes("complete")||t.includes("blocked")||t.includes("failed"))}):e;if(!r.length)return void(listEl.innerHTML="<li>No active items</li>");for(const e of r){const t=appColors[e.app]||"#7f8c8d",r=document.createElement("li"),n=normalizeStatus(e.status||""),a=formatEta(e.timeLeft||e.eta),d=formatSize(e.size);r.innerHTML=`<span class="flag" style="background:${t};"></span><span class="title">${e.title}</span><span class="status">${n}</span>`;const l=document.createElement("div");l.className="badges",n&&(o=document.createElement("span"),o.className="badge badge-status",o.textContent=n,l.appendChild(o)),a&&(i=document.createElement("span"),i.className="badge badge-eta",i.textContent=a,l.appendChild(i)),d&&(c=document.createElement("span"),c.className="badge badge-size",c.textContent=d,l.appendChild(c)),l.children.length>0&&r.appendChild(l);const s=document.createElement("div");s.className="actions-row";const p=document.createElement("button");p.className="btn-mini btn-remove",p.textContent="Remove",p.addEventListener("click",async()=>{p.disabled=!0;try{await device.removeQueueItem(e.app,e.id,{blocklist:!1}),Homey.showNotification("Removed"),load()}catch(e){Homey.alert("Error removing: "+e.message)}finally{p.disabled=!1}});const u=document.createElement("button");u.className="btn-mini btn-block",u.textContent="Block",u.addEventListener("click",async()=>{u.disabled=!0;try{await device.removeQueueItem(e.app,e.id,{blocklist:!0}),Homey.showNotification("Blocked"),load()}catch(e){Homey.alert("Error blocking: "+e.message)}finally{u.disabled=!1}}),s.appendChild(p),s.appendChild(u),r.appendChild(s),listEl.appendChild(r)}var o,i,c}async function load(){const e=await device.getStoreValue("queue_items"),t=await device.getCapabilityValue("measure_queue_count"),r=await device.getStoreValue("app_errors"),n=await device.getStoreValue("queue_app_counts");countEl.textContent=t||0,renderList(e||[]),renderStats(n||{}),renderErrors(r||[])}device.on("capability:measure_queue_count",e=>{countEl.textContent=e||0,device.getStoreValue("queue_items").then(renderList),device.getStoreValue("app_errors").then(renderErrors)}),load().catch(e=>{console.error("Error loading queue data:",e),renderList([])}),document.getElementById("btn-pause").addEventListener("click",async()=>{const e=document.getElementById("btn-pause");e.disabled=!0,e.textContent="...";try{await device.pauseAllDownloads(),Homey.showNotification("Paused")}catch(t){Homey.alert("Error: "+t.message)}finally{e.disabled=!1,e.textContent="Pause"}}),document.getElementById("btn-resume").addEventListener("click",async()=>{const e=document.getElementById("btn-resume");e.disabled=!0,e.textContent="...";try{await device.resumeAllDownloads(),Homey.showNotification("Resumed")}catch(t){Homey.alert("Error: "+t.message)}finally{e.disabled=!1,e.textContent="Resume"}}),document.getElementById("btn-refresh").addEventListener("click",async()=>{const e=document.getElementById("btn-refresh");e.disabled=!0,e.textContent="...";try{await load()}catch(t){Homey.alert("Error: "+t.message)}finally{e.disabled=!1,e.textContent="Refresh"}});async function refreshApp(e){const t=document.getElementById(`btn-refresh-${e}`);if(t){t.disabled=!0;const r=t.textContent;t.textContent="...";try{await device.refreshApp(e),await load()}catch(n){Homey.alert(`Error ${e}: `+n.message)}finally{t.disabled=!1,t.textContent=r}}}document.getElementById("btn-refresh-radarr").addEventListener("click",()=>refreshApp("radarr")),document.getElementById("btn-refresh-sonarr").addEventListener("click",()=>refreshApp("sonarr")),document.getElementById("btn-refresh-lidarr").addEventListener("click",()=>refreshApp("lidarr")),toggleActiveEl.addEventListener("change",()=>{device.getStoreValue("queue_items").then(renderList)});</script></body></html>
